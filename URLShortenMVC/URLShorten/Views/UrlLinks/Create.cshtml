@model URLShorten.Data.Entities.UrlLink

@{
    ViewData["Title"] = "Create";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h1>Create</h1>
<h4>UrlLink</h4>
<hr />

<div class="row">
    <!-- Left: Create Form -->
    <div class="col-md-4">
        <form asp-action="Create" method="post" id="createForm">
            @Html.AntiForgeryToken()
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <!-- Original URL -->
            <div class="form-group">
                <label asp-for="OriginalUrl" class="control-label"></label>
                <input asp-for="OriginalUrl" class="form-control" id="originalUrlInput" />
                <span asp-validation-for="OriginalUrl" class="text-danger"></span>
            </div>

            <!-- Auto-Generated Shortened URL (rendered without client validation metadata) -->
            <div class="form-group">
                <label class="control-label">Shortened URL</label>
                <!-- plain input (no asp-for) prevents emitting data-val attributes -->
                <input name="ShortenedUrl" id="shortenedUrlInput" class="form-control" readonly />
                <!-- removed asp-validation-for for ShortenedUrl so no client-side message shows -->
            </div>

            <div class="form-group mt-3">
                <input type="submit" value="Create" class="btn btn-primary" />
            </div>
        </form>
    </div>

    <!-- Right: UrlLinksList Component -->
    <div class="col-md-8" id="linksListContainer">
        @await Component.InvokeAsync("UrlLinksList", new { isEditPage = false })
    </div>
</div>

<div class="mt-3 ">
@* <div class="mt-3"> *@
    @* <a asp-action="Index">Back to List</a> *@
</div>

<!-- Bootstrap modal used to show server-provided Delete view -->
<div class="modal fade" id="ajaxModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ajaxModalTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeModal()"></button>
      </div>
      <div class="modal-body" id="ajaxModalBody"></div>
    </div>
  </div>
</div>

@* Report message *@
<div id="reportSuccessMsg" class="alert alert-success d-none" role="alert"></div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")

    <script>
        // Auto-generate shortened URL via AJAX (existing)
        document.getElementById('originalUrlInput').addEventListener('change', async function () {
            const originalUrl = this.value.trim();
            if (!originalUrl) return;

            const response = await fetch('/UrlLinks/GenerateShort', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: new URLSearchParams({ originalUrl })
            });

            if (response.ok) {
                const data = await response.json();
                document.getElementById('shortenedUrlInput').value = data.shortenedUrl;
            }
        });

        // Create form submit via AJAX (existing)
        document.getElementById('createForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const response = await fetch(this.action, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const listHtml = await fetch('/UrlLinks/ReloadList').then(r => r.text());
                document.getElementById('linksListContainer').innerHTML = listHtml;
                this.reset();
                document.getElementById('shortenedUrlInput').value = '';
            } else {
                const txt = await response.text();
                alert('Create failed: ' + txt);
            }
        });

        // ---------- Modal helper ----------
        function openModal(title, bodyHtml) {
            document.getElementById('ajaxModalTitle').innerText = title;
            document.getElementById('ajaxModalBody').innerHTML = bodyHtml;
            var modalEl = new bootstrap.Modal(document.getElementById('ajaxModal'));
            modalEl.show();
        }
        function closeModal() {
            var modalEl = bootstrap.Modal.getInstance(document.getElementById('ajaxModal'));
            if (modalEl) modalEl.hide();
        }

        // ---------- UrlLink delete flow (jQuery style, matches your Authors example) ----------
        function openModalDeleteUrlLink(id) {
            $.ajax({
                url: "/UrlLinks/Delete",
                type: "GET",
                data: { id: id },
                beforeSend: function() { console.log("Requesting delete view..."); },
                success: function(response) {
                    openModal("Delete UrlLink", response);
                },
                error: function(xhr, status, error) {
                    console.error("Error loading delete view:", error);
                }
            });
        }

        function deleteUrlLink(id) {
            let inputToken = document.querySelector("input[name='__RequestVerificationToken']");
            let token = inputToken?.value;

            $.ajax({
                url: "/UrlLinks/Delete",
                type: "POST",
                data: {
                    id: id,
                    __RequestVerificationToken: token
                },
                beforeSend: function() { console.log("Sending delete..."); },
                success: function(response) {
                    console.log("Delete response:", response);
                    if (response && response.isOK) {
                        // reload list fragment
                        $.ajax({
                            url: "/UrlLinks/ReloadList",
                            type: "GET",
                            success: function(html) {
                                $("#linksListContainer").html(html);
                                closeModal();
                            },
                            error: function() { alert("Failed reloading list"); }
                        });
                    } else {
                        // fallback: reload entire page
                        location.reload();
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Delete failed:", error, xhr.responseText);
                    alert("Delete failed: " + (xhr.responseText || error));
                }
            });
        }

        function openModalReportUrlLink(id) {
            var html = `
                <h1>Report</h1>
                <h3>Are you sure you want to report this link?</h3>
                <div>
                    <button type="button" class="btn btn-warning btn-sm" onclick="reportUrlLink(${id})">Report</button>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="closeModal();">Cancel</button>
                </div>
            `;
            openModal("Report UrlLink", html);
        }

        function reportUrlLink(id) {
            closeModal();
            var msgDiv = document.getElementById('reportSuccessMsg');
            msgDiv.textContent = "Report sent successfully!";
            msgDiv.classList.remove('d-none');
            setTimeout(function() {
                msgDiv.classList.add('d-none');
            }, 3000);
        }
    </script>
}
